/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package gui;

import static init.MainClass.con;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.JOptionPane;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;
import javax.swing.text.PlainDocument;
import static utils.Constants.EDIT_MODE;
import utils.HelperClass;
import utils.InputType;
import utils.Queries;

/**
 *
 * @author asus
 */
public class CardLengths extends MyInternalFrame {

    private String addLength;
    private String addDescription;
    private String updateLength;
    private String updateDescription;

    /**
     * Creates new form CardLength
     *
     * @param title
     * @param type
     */
    public CardLengths(String title, String type) {
        super(title, type);
        setMode(EDIT_MODE);
        initComponents();
        fillLengths();

        // set document filters to text fields
        PlainDocument addDescriptionDoc = (PlainDocument) tfAddDescription.getDocument();
        addDescriptionDoc.setDocumentFilter(new utils.MyDocFilter(InputType.TEXT20));
        
        PlainDocument addSignDoc = (PlainDocument) tfAddSign.getDocument();
        addSignDoc.setDocumentFilter(new utils.MyDocFilter(InputType.CHAR1));
        
        PlainDocument updateDescriptionDoc = (PlainDocument) tfUpdateDescription.getDocument();
        updateDescriptionDoc.setDocumentFilter(new utils.MyDocFilter(InputType.TEXT20));
        
        PlainDocument updateSignDoc = (PlainDocument) tfUpdateSign.getDocument();
        updateSignDoc.setDocumentFilter(new utils.MyDocFilter(InputType.CHAR1));

        tblLengths.getSelectionModel().addListSelectionListener(new ListSelectionListener() {

            @Override
            public void valueChanged(ListSelectionEvent e) {
                boolean isRowSelected = tblLengths.getSelectedRow() != -1;
                btnRemove.setEnabled(isRowSelected);
                btnUpdate.setEnabled(isRowSelected);

                if (isRowSelected) {
                    int selectedRow = tblLengths.getSelectedRow();
                    tfUpdateSign.setText(tblLengths.getModel().getValueAt(selectedRow, 0).toString());
                    tfUpdateDescription.setText(tblLengths.getModel().getValueAt(selectedRow, 1).toString());
                }
            }
        });

    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        pExistingLengths = new javax.swing.JPanel();
        jScrollPane1 = new javax.swing.JScrollPane();
        tblLengths = new javax.swing.JTable();
        pAddLength = new javax.swing.JPanel();
        lblAddSign = new javax.swing.JLabel();
        lblAddDescription = new javax.swing.JLabel();
        tfAddSign = new javax.swing.JTextField();
        btnAdd = new javax.swing.JButton();
        tfAddDescription = new javax.swing.JTextField();
        pEditLength = new javax.swing.JPanel();
        lblUpdateSign = new javax.swing.JLabel();
        lblUpdateDescription = new javax.swing.JLabel();
        tfUpdateDescription = new javax.swing.JTextField();
        btnUpdate = new javax.swing.JButton();
        btnRemove = new javax.swing.JButton();
        tfUpdateSign = new javax.swing.JTextField();

        pExistingLengths.setBorder(javax.swing.BorderFactory.createTitledBorder(javax.swing.BorderFactory.createTitledBorder("Lengths"), "Existing lengths"));

        tblLengths.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null}
            },
            new String [] {
                "Title 1", "Title 2", "Title 3", "Title 4"
            }
        ));
        jScrollPane1.setViewportView(tblLengths);

        javax.swing.GroupLayout pExistingLengthsLayout = new javax.swing.GroupLayout(pExistingLengths);
        pExistingLengths.setLayout(pExistingLengthsLayout);
        pExistingLengthsLayout.setHorizontalGroup(
            pExistingLengthsLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pExistingLengthsLayout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jScrollPane1, javax.swing.GroupLayout.DEFAULT_SIZE, 227, Short.MAX_VALUE)
                .addContainerGap())
        );
        pExistingLengthsLayout.setVerticalGroup(
            pExistingLengthsLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pExistingLengthsLayout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 0, Short.MAX_VALUE)
                .addContainerGap())
        );

        pAddLength.setBorder(javax.swing.BorderFactory.createTitledBorder("Add Length"));

        lblAddSign.setText("Sign");

        lblAddDescription.setText("Description");

        btnAdd.setText("Add");
        btnAdd.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnAddActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout pAddLengthLayout = new javax.swing.GroupLayout(pAddLength);
        pAddLength.setLayout(pAddLengthLayout);
        pAddLengthLayout.setHorizontalGroup(
            pAddLengthLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pAddLengthLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(pAddLengthLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                    .addGroup(pAddLengthLayout.createSequentialGroup()
                        .addComponent(lblAddDescription)
                        .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                    .addGroup(pAddLengthLayout.createSequentialGroup()
                        .addComponent(lblAddSign)
                        .addGap(61, 61, 61)
                        .addComponent(tfAddSign, javax.swing.GroupLayout.PREFERRED_SIZE, 51, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(171, 171, 171))))
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, pAddLengthLayout.createSequentialGroup()
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addComponent(btnAdd, javax.swing.GroupLayout.PREFERRED_SIZE, 72, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap())
            .addGroup(pAddLengthLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                .addGroup(pAddLengthLayout.createSequentialGroup()
                    .addGap(97, 97, 97)
                    .addComponent(tfAddDescription)
                    .addGap(104, 104, 104)))
        );
        pAddLengthLayout.setVerticalGroup(
            pAddLengthLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pAddLengthLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(pAddLengthLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblAddSign)
                    .addComponent(tfAddSign, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(lblAddDescription)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(btnAdd)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
            .addGroup(pAddLengthLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, pAddLengthLayout.createSequentialGroup()
                    .addContainerGap(46, Short.MAX_VALUE)
                    .addComponent(tfAddDescription, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addGap(35, 35, 35)))
        );

        pEditLength.setBorder(javax.swing.BorderFactory.createTitledBorder("Edit Length"));

        lblUpdateSign.setText("Sign");

        lblUpdateDescription.setText("Description");

        btnUpdate.setText("Update");
        btnUpdate.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnUpdateActionPerformed(evt);
            }
        });

        btnRemove.setText("Remove");
        btnRemove.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnRemoveActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout pEditLengthLayout = new javax.swing.GroupLayout(pEditLength);
        pEditLength.setLayout(pEditLengthLayout);
        pEditLengthLayout.setHorizontalGroup(
            pEditLengthLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pEditLengthLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(pEditLengthLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(pEditLengthLayout.createSequentialGroup()
                        .addComponent(lblUpdateDescription)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED))
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, pEditLengthLayout.createSequentialGroup()
                        .addComponent(lblUpdateSign)
                        .addGap(50, 50, 50)))
                .addGroup(pEditLengthLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addGroup(pEditLengthLayout.createSequentialGroup()
                        .addComponent(tfUpdateSign, javax.swing.GroupLayout.PREFERRED_SIZE, 51, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(68, 68, 68))
                    .addComponent(tfUpdateDescription))
                .addContainerGap(114, Short.MAX_VALUE))
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, pEditLengthLayout.createSequentialGroup()
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addComponent(btnRemove)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(btnUpdate)
                .addContainerGap())
        );
        pEditLengthLayout.setVerticalGroup(
            pEditLengthLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pEditLengthLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(pEditLengthLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblUpdateSign)
                    .addComponent(tfUpdateSign, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(pEditLengthLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblUpdateDescription)
                    .addComponent(tfUpdateDescription, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 13, Short.MAX_VALUE)
                .addGroup(pEditLengthLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(btnUpdate)
                    .addComponent(btnRemove))
                .addContainerGap())
        );

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(pExistingLengths, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(18, 18, 18)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(pAddLength, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(pEditLength, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addComponent(pExistingLengths, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(pAddLength, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addComponent(pEditLength, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void btnAddActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnAddActionPerformed

        try {

            int choice = JOptionPane.showInternalOptionDialog(this,
                    "Changing existing lengths may cause consistency issues!\n"
                    + "Are you sure you want to proceed?",
                    "Bummer!",
                    JOptionPane.YES_NO_OPTION,
                    JOptionPane.WARNING_MESSAGE, null, null, null);
            if (choice == JOptionPane.NO_OPTION) {
                return;
            }

            PreparedStatement st = con.prepareStatement(Queries.INSERT_LENGTH);
            st.setString(1, addLength);
            st.setString(2, addDescription);
            st.executeUpdate();

            fillLengths();

        } catch (SQLException e) {
            switch (e.getErrorCode()) {
                case 2627:
                    if (e.getMessage().contains("The duplicate key value is (2)")) {
                        JOptionPane.showInternalMessageDialog(this,
                                "This sign is already in use! Pick another one",
                                "Bummer!",
                                JOptionPane.ERROR_MESSAGE);
                    } else if (e.getMessage().contains("The duplicate key value is (1)")) {
                        JOptionPane.showInternalMessageDialog(this,
                                "This length is already in use! Pick another one",
                                "Bummer!",
                                JOptionPane.ERROR_MESSAGE);
                    }
            }
        }
    }//GEN-LAST:event_btnAddActionPerformed

    private void btnRemoveActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnRemoveActionPerformed

        int choice = JOptionPane.showInternalOptionDialog(this,
                "Changing lengths may cause consistency problems!\n"
                + "Are you sure you want to proceed?",
                "Bummer!",
                JOptionPane.YES_NO_OPTION,
                JOptionPane.WARNING_MESSAGE, null, null, null);
        if (choice == JOptionPane.NO_OPTION) {
            return;
        }

        PreparedStatement st;

        try {
            st = con.prepareStatement(Queries.DELETE_LENGTH);
            st.setString(1, updateLength);
            st.executeUpdate();

            fillLengths();
        } catch (SQLException e) {
            switch (e.getErrorCode()) {
                case 547:
                    JOptionPane.showInternalMessageDialog(this,
                            "This length can not be deleted since\n"
                            + "it hase already been in use!",
                            "Bummer!",
                            JOptionPane.ERROR_MESSAGE);
                    break;
            }
            System.err.println("Error code: " + e.getErrorCode() + "\nError Message: " + e.getMessage());
        }
    }//GEN-LAST:event_btnRemoveActionPerformed

    private void btnUpdateActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnUpdateActionPerformed
        try {

            int choice = JOptionPane.showInternalOptionDialog(this,
                    "Changing existing lengths may cause consistency issues!\n"
                    + "Are you sure you want to proceed?",
                    "Bummer!",
                    JOptionPane.YES_NO_OPTION,
                    JOptionPane.WARNING_MESSAGE, null, null, null);
            if (choice == JOptionPane.NO_OPTION) {
                return;
            }

            PreparedStatement st = con.prepareStatement(Queries.UPDATE_LENGTH);
            st.setString(1, updateDescription);
            st.setString(2, updateLength);
            st.executeUpdate();

            fillLengths();

        } catch (SQLException e) {
            switch (e.getErrorCode()) {
                case 2627:
                    JOptionPane.showInternalMessageDialog(this,
                            "This length is already in use! Pick another one",
                            "Bummer!",
                            JOptionPane.ERROR_MESSAGE);
                    break;
            }
        }
    }//GEN-LAST:event_btnUpdateActionPerformed


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnAdd;
    private javax.swing.JButton btnAdd2;
    private javax.swing.JButton btnRemove;
    private javax.swing.JButton btnUpdate;
    private javax.swing.JComboBox cmbSign2;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JLabel lblAddDescription;
    private javax.swing.JLabel lblAddSign;
    private javax.swing.JLabel lblDescription2;
    private javax.swing.JLabel lblLength3;
    private javax.swing.JLabel lblUpdateDescription;
    private javax.swing.JLabel lblUpdateSign;
    private javax.swing.JPanel pAddLength;
    private javax.swing.JPanel pAddLength2;
    private javax.swing.JPanel pEditLength;
    private javax.swing.JPanel pExistingLengths;
    private javax.swing.JTable tblLengths;
    private javax.swing.JTextField tfAddDescription;
    private javax.swing.JTextField tfAddSign;
    private javax.swing.JTextField tfDescription2;
    private javax.swing.JTextField tfUpdateDescription;
    private javax.swing.JTextField tfUpdateSign;
    // End of variables declaration//GEN-END:variables

    private void fillLengths() {

        try {
            Statement s = con.createStatement();
            ResultSet rs = s.executeQuery(Queries.SELECT_ALL_LENGTHS);
            tblLengths.setModel(HelperClass.buildTableModel(rs));

        } catch (SQLException ex) {
            Logger.getLogger(CardLengths.class.getName()).log(Level.SEVERE, null, ex);
        }
    }

    private boolean isOkToAdd() {
        return true;
    }

}
